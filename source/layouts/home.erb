<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <%= partial "shared/metatags" %>
    <%= stylesheet_link_tag "application" %>
    <%= favicon_tag 'images/favicon.png' %>
  </head>
  <body>
    <%= yield %>
    <%= partial "shared/propose_modal" %>
    <%= partial "shared/alert" %>
    <%= javascript_include_tag "application" %>
    <script>
      const signUp = document.querySelector("#mc-embedded-subscribe-form");
      const submitButton = document.querySelector("#mc-embedded-subscribe");
      let close;

      updateMsg = (cssClass, msg) => {
        clearTimeout(close);
        document.querySelector('#alert').classList = '';
        document.querySelector('#alert').classList.add(cssClass);
        document.querySelector('#alert').classList.add('alert-appears');
        document.querySelector('#message').innerText = msg;
        close = setTimeout((() => { closeAlertMessage(); }), 10000);
      }

      register = (form) => {
        const msgSuccess = 'Merci pour ton inscription. N\'oublie pas de valider ton adresse mail !' ;
        const msgError = 'Oups, une erreur est survenue :(';

        fetch(form.action + '&EMAIL=' + form[0].value + '&c=', {
            method: form.method,
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json; charset=utf-8'
            },
          }).then(function() {
            updateMsg('success', msgSuccess);
          }).catch(function(error) {
            updateMsg('error', msgError);
          });
      }

      validateEmail = (email) => {
        const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(email)
      }

      subscribe = (e) => {
        e.preventDefault();
        const email = signUp[0].value;
        if (validateEmail(email)) {
          register(signUp);
        } else {
          const invalidEmail = "Ton mail ne semble pas valide..."
          updateMsg('error', invalidEmail);
        }
      }

      submitButton.addEventListener('click', subscribe);
    </script>
  </body>
</html>
